---
title: Database Consolidation
description: Querying across multiple databases with composite connections.
---

# Database Consolidation

Querying across multiple databases with composite connections.

## Overview

Organizations often have data spread across many SQLite databases. db-yard's composite connections allow querying across all of them without migration or consolidation.

## The Problem

```
Before: Siloed Data
+─────────────+ +─────────────+ +─────────────+
| Tenant A    | | Tenant B    | | Tenant C    |
| data.db     | | data.db     | | data.db     |
|             | |             | |             |
| - users     | | - users     | | - users     |
| - orders    | | - orders    | | - orders    |
+─────────────+ +─────────────+ +─────────────+
        |              |              |
        v              v              v
   Separate queries for each tenant
```

## The Solution

```
After: Composite View
+────────────────────────────────────────────+
|           Composite Connection              |
|                                            |
|  ATTACH tenant_a.data.db AS tenant_a;      |
|  ATTACH tenant_b.data.db AS tenant_b;      |
|  ATTACH tenant_c.data.db AS tenant_c;      |
|                                            |
|  CREATE VIEW all_orders AS                 |
|    SELECT 'A' as tenant, * FROM tenant_a.orders |
|    UNION ALL                               |
|    SELECT 'B' as tenant, * FROM tenant_b.orders |
|    UNION ALL                               |
|    SELECT 'C' as tenant, * FROM tenant_c.orders;|
+────────────────────────────────────────────+
        |
        v
   Single query across all tenants
```

## Implementation

### Step 1: Organize Databases

```
cargo.d/
├── tenants/
│   ├── tenant-a/
│   │   └── data.sqlite.db
│   ├── tenant-b/
│   │   └── data.sqlite.db
│   └── tenant-c/
│   │   └── data.sqlite.db
└── analytics/
    └── composite.sqlite.db
```

### Step 2: Generate Composite SQL

```bash
./bin/yard.ts cc \
  --volume-root $(pwd)/cargo.d \
  --scope cross-tenant \
  > composite.sql
```

Output:
```sql
-- Composite connection for cross-tenant scope
-- Generated by db-yard

ATTACH DATABASE 'tenants/tenant-a/data.sqlite.db' AS tenant_a;
ATTACH DATABASE 'tenants/tenant-b/data.sqlite.db' AS tenant_b;
ATTACH DATABASE 'tenants/tenant-c/data.sqlite.db' AS tenant_c;
```

### Step 3: Add Unified Views

```sql
-- Append to composite.sql

CREATE VIEW all_users AS
SELECT 'tenant-a' AS tenant, * FROM tenant_a.users
UNION ALL
SELECT 'tenant-b' AS tenant, * FROM tenant_b.users
UNION ALL
SELECT 'tenant-c' AS tenant, * FROM tenant_c.users;

CREATE VIEW all_orders AS
SELECT 'tenant-a' AS tenant, * FROM tenant_a.orders
UNION ALL
SELECT 'tenant-b' AS tenant, * FROM tenant_b.orders
UNION ALL
SELECT 'tenant-c' AS tenant, * FROM tenant_c.orders;

CREATE VIEW revenue_by_tenant AS
SELECT
    tenant,
    SUM(amount) as total_revenue,
    COUNT(*) as order_count
FROM all_orders
GROUP BY tenant;
```

### Step 4: Create Composite Database

```bash
sqlite3 cargo.d/analytics/composite.sqlite.db < composite.sql
```

### Step 5: Query Across Tenants

```sql
-- Connect to composite
sqlite3 cargo.d/analytics/composite.sqlite.db

-- Query all tenants
SELECT * FROM revenue_by_tenant ORDER BY total_revenue DESC;

-- Find top customers across all tenants
SELECT tenant, customer_id, SUM(amount) as total
FROM all_orders
GROUP BY tenant, customer_id
ORDER BY total DESC
LIMIT 10;
```

## Advanced: DuckDB Analytics

For heavy analytics, use DuckDB:

```bash
./bin/yard.ts cc \
  --volume-root $(pwd)/cargo.d \
  --scope cross-tenant \
  --dialect DuckDB \
  --duckdb-sqlite-ext \
  > duckdb-composite.sql
```

```sql
-- DuckDB composite
INSTALL sqlite;
LOAD sqlite;

ATTACH 'tenants/tenant-a/data.sqlite.db' AS tenant_a (TYPE sqlite);
ATTACH 'tenants/tenant-b/data.sqlite.db' AS tenant_b (TYPE sqlite);
ATTACH 'tenants/tenant-c/data.sqlite.db' AS tenant_c (TYPE sqlite);

-- Analytics query with DuckDB optimizations
SELECT
    tenant,
    DATE_TRUNC('month', order_date) as month,
    SUM(amount) as revenue
FROM all_orders
GROUP BY tenant, month
ORDER BY month, tenant;
```

## Use Cases

### Cross-Tenant Reporting

```sql
-- Monthly revenue across all tenants
SELECT
    strftime('%Y-%m', order_date) as month,
    tenant,
    SUM(amount) as revenue
FROM all_orders
GROUP BY month, tenant;
```

### Data Quality Checks

```sql
-- Find orphaned records
SELECT 'tenant-a' as tenant, o.id
FROM tenant_a.orders o
LEFT JOIN tenant_a.users u ON o.user_id = u.id
WHERE u.id IS NULL
UNION ALL
SELECT 'tenant-b' as tenant, o.id
FROM tenant_b.orders o
LEFT JOIN tenant_b.users u ON o.user_id = u.id
WHERE u.id IS NULL;
```

### Aggregated Dashboards

Create a SQLPage dashboard for the composite:

```sql
-- Add to composite database
CREATE TABLE sqlpage_files (
    path TEXT PRIMARY KEY,
    contents TEXT,
    last_modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO sqlpage_files (path, contents) VALUES
('index.sql', '
SELECT ''chart'' AS component,
       ''bar'' AS type,
       ''Revenue by Tenant'' AS title;
SELECT tenant, total_revenue
FROM revenue_by_tenant
ORDER BY total_revenue DESC;

SELECT ''table'' AS component,
       ''Recent Orders'' AS title;
SELECT tenant, order_id, amount, order_date
FROM all_orders
ORDER BY order_date DESC
LIMIT 20;
');
```

## Best Practices

### Performance

1. **Index frequently queried columns** in source databases
2. **Use DuckDB** for heavy analytics
3. **Materialize views** for repeated queries
4. **Limit result sets** when exploring

### Maintenance

1. **Regenerate composites** when schemas change
2. **Version control composite.sql**
3. **Document view definitions**
4. **Test queries** against composite

### Security

1. **Read-only by default** - prevent cross-tenant writes
2. **Validate tenant IDs** - don't accept user input in queries
3. **Audit access** - log composite database usage

---

See also: [Composite Connections](../advanced/composites.md), [CLI Reference](../reference/cli.md)